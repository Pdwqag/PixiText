# プレビュー分割案の評価

依頼内容: 単一のプレビュー画面のまま、ボタン操作でページ番号などの変数を切り替え、本文の表示を更新した後にページ先頭へスクロールする挙動で小説をページ分割できないか、というもの。

## 実現の可否
- **可能**。サーバー側で生成済みのページ配列を保持しているため、現在の `/preview?p=N` GET に相当するデータだけを取り出して描画すればよい。画面遷移を伴わない形でも同等のページ送りが実装できる。
- Flask/Jinja のままでもページ番号をクエリで受けて再描画する既存の仕組みを利用できる。フロント側だけで完結させるなら、ページ内容を JSON で返す API を作り、JavaScript で本文とページ番号を差し替える方法が現実的。

## 実装時のポイント
- ページ番号などの「変数を動かす」操作は、ボタンのクリックイベントで状態を更新し、`window.scrollTo(0, 0)` などでページトップへ戻す。セクション ID へのアンカーリンクでも同様の効果が得られる。
- ステート保持は以下のいずれかで可能:
  - **サーバー依存のまま**: 現行の `p` クエリパラメータを使い、`fetch` で HTML 断片または JSON を取りに行く。
  - **クライアント完結**: セッションに保存済みの本文をサーバーから一度取得し、`parse_document` 相当の処理を JS に移してページ配列を持つ。
- アクセシビリティと SEO を考えるなら、リンクによるページ遷移をフォールバックとして残しつつ、`history.replaceState` で URL も同期しておくとブックマークしやすい。

## 既存フローとの整合性
- 現在も POST 後に `/preview?p=1` へリダイレクトする形でページ番号を扱っているため、同じ番号スキームを活かせば保存機能（セッション保存・HTML エクスポート）への影響は小さい。
- もし新しい API を作る場合でも、本文をセッションに置く前提を変えなければ保存周りの既存処理はそのまま再利用できる。

## 想定される課題
- ページ分割ロジックをフロントへ持ち出す場合、`parse_document` と同等の段組み・縦書き対応を JS へ移植する必要があり、現状よりロジックが重複する。
- クライアントでページ配列を保持する場合、大きな本文ではメモリ使用量と初回ロードの負荷が増える。リクエストごとに1ページを返すサーバーサイド描画の方がスケールしやすい。

## 結論
- ボタン操作でページ変数を変更し、トップへ戻すだけで単一ページ内ページ送りを実現する案は現行アーキテクチャでも実装可能。まずは既存の `/preview?p=` エンドポイントを活かし、フロントで `fetch` ＋ DOM 差し替えを行う軽量実装から試すのが安全。
