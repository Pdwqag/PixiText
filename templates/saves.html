{% extends "base.html" %}
{% block content %}
<section class="panel">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Draft Archive</span>
      <h2 class="panel-title">保存済みテキスト一覧</h2>
      <p class="panel-description">保存しているテキスト一覧です</p>
    </div>
  </header>

  <form method="get" action="{{ url_for('saves_list') }}" class="saves-search" role="search">
    <input type="search" name="q" value="{{ q or '' }}" class="saves-search__input"
           placeholder="文書を検索（ファイル名）" autocomplete="off">
    <button type="submit" class="btn">検索</button>
    {% if q %}
      <a class="btn" href="{{ url_for('saves_list') }}">クリア</a>
    {% endif %}
  </form>


  {% if files %}
    <div class="saves-list">
      {% for f in files %}
        <div class="mg-card">

          <!-- ★ 角アイコン（ギャラリーと同じ配置） -->
          <div class="mg-corner">
            <!-- 左上：公開範囲トグル -->
            {% set vis = f.visibility or 'private' %}
            <form method="post"
                  action="{{ url_for('saves_set_visibility') }}"
                  class="corner-left js-vis-toggle"
                  data-current="{{ vis }}">
              <input type="hidden" name="fname" value="{{ f.name }}">
              <input type="hidden" name="visibility" value="{{ vis }}">
              <button type="button" class="corner-btn" title="公開範囲を切り替え">
                {% if vis == 'public' %}
                  <img src="{{ url_for('static', filename='picture/earth.png') }}">
                {% elif vis == 'unlisted' %}
                  <img src="{{ url_for('static', filename='picture/chain.png') }}">
                {% else %}
                  <img src="{{ url_for('static', filename='picture/lock.png') }}">
                {% endif %}
              </button>
            </form>

            <!-- 右上：削除 -->
            <form method="post"
                  action="{{ url_for('saves_delete') }}"
                  class="corner-right js-delete"
                  data-what="テキスト" data-id="{{ f.name }}">
              <input type="hidden" name="fname" value="{{ f.name }}">
              <button class="corner-btn danger" type="submit" title="削除">
                <img src="{{ url_for('static', filename='picture/cross.png') }}" alt="">
              </button>
            </form>
          </div>

          <div class="mg-body">
            <!-- ファイル名 -->
            <div class="mg-id" title="{{ f.name }}">{{ f.name }}</div>
            <!-- メタ情報 -->
            <div class="mg-name">{{ f.size_kb }} KB ・ {{ f.mtime_str }}</div>

            <div class="save-controls">
              <!-- 上に固定 / 固定解除 -->
              <form method="post" action="{{ url_for('saves_toggle_pin') }}" class="pin-form">
                <input type="hidden" name="fname" value="{{ f.name }}">
                <button class="btn btn-mini" type="submit" title="{% if f.pinned %}固定解除{% else %}上に固定{% endif %}">
                  <img class="ui-icon" src="{{ url_for('static', filename='picture/' ~ ('brack_pin.png' if f.pinned else 'white_pin.png')) }}" alt="">
                </button>
              </form>
              <!-- 右側アクション -->
              <div class="save-actions">
                <form method="get" action="{{ url_for('saves_open') }}">
                  <input type="hidden" name="fname" value="{{ f.name }}">
                  <button class="btn btn-mini" type="submit" title="編集">
                    <img class="ui-icon" src="{{ url_for('static', filename='picture/edit.png') }}" alt="">
                  </button>
                </form>

              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p class="empty-hint">まだ保存されたテキストがありません。エディタで「保存」してください。</p>
  {% endif %}

  <!-- <div class="panel-divider"></div>
  {% if cloud_manifest.gcs.enabled %}
    <section class="cloud-note cloud-note--accent" aria-label="Google Cloud Storage 情報">
      <p><strong>Google Cloud Storage を確認する</strong></p>
      {% set creds = cloud_manifest.gcs.credentials %}
      <ul>
        <li>プロジェクト ID: <code>{{ cloud_manifest.gcs.project }}</code></li>
        <li>バケット名: <code>{{ cloud_manifest.gcs.bucket }}</code></li>
        <li>対象フォルダ: <code>{{ gcs_saves_prefix }}</code></li>
        {% if creds.source %}
          <li>資格情報ソース: <code>{{ creds.source }}</code>{% if creds.path %} (<code>{{ creds.path }}</code>){% endif %}</li>
        {% endif %}
      </ul>
      <p>クラウドにテキストを保存できていない場合は、サービスアカウント権限や資格情報の設定を見直してください。</p>
      {% if creds.env_path %}
        <p class="cloud-note__hint">GOOGLE_APPLICATION_CREDENTIALS: <code>{{ creds.env_path }}</code>
          {% if creds.env_path_exists %}
            は解決済みです。
          {% else %}
            が見つかりません。デプロイ環境にファイルが存在するか確認してください。
          {% endif %}
        </p>
      {% endif %}
    </section>
  {% else %}
    <p class="cloud-note">Google Cloud Storage を有効化すると、ここにテキストバックアップへのショートカットが表示されます。</p>
  {% endif %} -->
</section>
{% endblock %}
