{% extends "base.html" %}
{% block content %}


<!-- ===== エディタ ===== -->
<section class="panel panel--editor" id="editor">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Writing Toolkit</span>
      <h2 class="panel-title">本文エディタ</h2>
      <p class="panel-description">ここで編集しましょう。入力内容はブラウザ内に自動保存されます。</p>
    </div>
  </header>

  <!-- プレビュー/保存 兼用フォーム（保存は formaction で切替） -->
  <form method="post" action="{{ url_for('preview') }}" novalidate>
    <label for="text">タグのショートカット</label>

    <div class="shortcut-bar">
      <button type="button" class="ins" data-insert="[newpage]">[newpage]</button>
      <button type="button" class="ins" data-insert="[chapter:章タイトル]">[chapter]</button>
      <button type="button" class="ins" data-insert="[uploadedimage:123456]">[uploadedimage]</button>
      <button type="button" class="ins" data-insert="[jump:2]">[jump]</button>
      <button type="button" class="ins" data-insert="[[jumpuri:タイトル > https://example.com]]">[[jumpuri]]</button>
      <button type="button" class="ins" data-insert="[[rb:漢字 > かんじ]]">[[rb]]</button>
      <button type="button" class="ins" data-insert="[pixivimage:]">[pixivimage]</button>
            <!-- プレビュー -->
      <button type="button" class="ins-preview" data-ajax-preview title="プレビュー (Ctrl+Enter)">
        <img class="ui-icon" src="{{ url_for('static', filename='picture/keyboard.png') }}" alt="" aria-hidden="true">
        プレビュー
      </button>

    </div>

    <textarea id="text" name="text" rows="18" placeholder="ここに本文">{{ default_text }}</textarea>

      <!-- ファイル名入力 -->
      <input
        type="text"
        name="filename"
        placeholder="ファイル名（例: story.txt）"
        value="{{ last_filename or '' }}"
      >
<div class="editor-actions">
  <a href="{{ url_for('saves_list') }}" class="btn">保存した作品を一覧表示</a>

  <button
    type="button"
    class="btn primary"
    data-ajax-save
    data-action="{{ url_for('save_local') }}"
  >ローカルに保存</button>

  <button
    type="submit"
    class="btn icon-round"
    formaction="{{ url_for('export') }}"
    formmethod="post"
    title="エクスポート"
  >
    <img class="ui-icon" src="{{ url_for('static', filename='picture/upload.png') }}" alt="">
  </button>
</div>


  </form>

  {% if cloud_targets %}
<section class="panel panel--cloud" id="cloud-mirror">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Cloud Mirror</span>
      <h2 class="panel-title">クラウドバックアップ</h2>
      <p class="panel-description">Google Cloud Storage 上のミラーフォルダへ素早くアクセスできます。バックアップの確認や共有権限の調整に活用してください。</p>
    </div>
  </header>

  <div class="cloud-links">
    {% for provider in cloud_targets %}
      {% if provider.uploads_url %}
        <article class="cloud-link-card" data-provider="{{ provider.key }}" data-section="uploads">
          <h3 class="cloud-link-card__title">{{ provider.label }} 挿絵アップロード</h3>
          <p class="cloud-link-card__text"><code>uploads/</code> ディレクトリのバックアップです。別デバイスから素材を取り込む際や履歴の確認にご利用ください。</p>
          <a class="link-button subtle" href="{{ provider.uploads_url }}" target="_blank" rel="noopener">{{ provider.label }} で開く</a>
        </article>
      {% endif %}

      {% if provider.saves_url %}
        <article class="cloud-link-card" data-provider="{{ provider.key }}" data-section="saves">
          <h3 class="cloud-link-card__title">{{ provider.label }} テキスト保存</h3>
          <p class="cloud-link-card__text"><code>saves/</code> ディレクトリの原稿バックアップです。必要に応じてアクセス権やバージョン管理を設定してください。</p>
          <a class="link-button subtle" href="{{ provider.saves_url }}" target="_blank" rel="noopener">{{ provider.label }} で開く</a>
        </article>
      {% endif %}
    {% endfor %}
  </div>

  {% if cloud_manifest.gcs.enabled %}
    <div class="cloud-note cloud-note--accent">
      <p><strong>Google Cloud Storage 接続情報</strong></p>
      <ul>
        <li>プロジェクト ID: <code>{{ cloud_manifest.gcs.project }}</code></li>
        <li>バケット名: <code>{{ cloud_manifest.gcs.bucket }}</code></li>
        <li>サービスアカウント: <code>{{ cloud_manifest.gcs.service_account }}</code></li>
        {% set creds = cloud_manifest.gcs.credentials %}
        {% if creds.source %}
          <li>資格情報ソース: <code>{{ creds.source }}</code>{% if creds.path %} (<code>{{ creds.path }}</code>){% endif %}</li>
        {% endif %}
        {% if creds.env_path %}
          <li>GOOGLE_APPLICATION_CREDENTIALS: <code>{{ creds.env_path }}</code>
            {% if creds.env_path_exists %}
              <span aria-label="credential path resolved" title="credential path resolved">✅</span>
            {% else %}
              <span aria-label="credential path missing" title="credential path missing">⚠️</span>
            {% endif %}
          </li>
        {% endif %}
      </ul>
      <p>サービスアカウントに対象バケットへの書き込み権限があるか、Render 等のデプロイ環境に資格情報が配置されているかをご確認ください。</p>
    </div>
  {% else %}
    <p class="cloud-note">クラウドバックアップを有効化するには、環境変数で Google Cloud Storage の資格情報とバケット名を設定してください。</p>
  {% endif %}
</section>
{% endif %}

<script>
(() => {
  const textEl = document.getElementById('text');
  const nameEl = document.querySelector('input[name="filename"]');
  const previewForm = document.querySelector('form[action$="/preview"]'); // 送信自体は使わないがdraft保存に使う
  const previewBox = document.getElementById('previewBox'); // ←あなたのDOMに合わせてID調整してOK

  // ---- draft ----
  const draftKey = () => `pixi:draft:${(nameEl?.value || '(untitled)').trim()}`;

  try {
    const k = draftKey();
    const draft = localStorage.getItem(k);
    if (draft && textEl && draft !== textEl.value) textEl.value = draft;
  } catch (e) {}

  let t = null;
  const saveDraft = () => {
    try { if (textEl) localStorage.setItem(draftKey(), textEl.value); } catch (e) {}
  };
  const debounced = () => { clearTimeout(t); t = setTimeout(saveDraft, 250); };
  textEl?.addEventListener('input', debounced);

  nameEl?.addEventListener('change', () => {
    saveDraft();
    try { if (textEl) localStorage.setItem(draftKey(), textEl.value); } catch (e) {}
  });

  previewForm?.addEventListener('submit', () => saveDraft());

  document.addEventListener('pixi:saved', (ev) => {
    try {
      if (ev?.detail?.filename && nameEl) nameEl.value = ev.detail.filename;
      saveDraft();
    } catch (e) {}
  });

  // ---- insert buttons ----
  document.addEventListener("click", (e) => {
    const btn = e.target.closest("button.ins[data-insert]");
    if (!btn) return;

    const insert = btn.dataset.insert;
    const ta = document.getElementById("text");
    if (!ta || !insert) return; // ←insert未定義なら何もしない（undefined混入防止）

    const start = ta.selectionStart ?? ta.value.length;
    const end = ta.selectionEnd ?? ta.value.length;

    ta.value = ta.value.slice(0, start) + insert + ta.value.slice(end);
    ta.selectionStart = ta.selectionEnd = start + insert.length;
    ta.focus();
  });

  // ---- ajax preview ----
// ---- preview (navigate to /preview) ----
document.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-ajax-preview]");
  if (!btn) return;

  // 絶対に他のクリック処理やsubmitに飲まれない
  e.preventDefault();
  e.stopPropagation();
  e.stopImmediatePropagation();

  const form = btn.closest("form");
  if (!form) return;

  const ta = form.querySelector("#text");
  if (ta) {
    ta.value = ta.value.replace(/^undefined\s*/i, "");
  }

  form.submit();
}, true);

})();
</script>


{% endblock %}
