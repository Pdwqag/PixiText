{% extends "base.html" %}
{% block content %}


<!-- ===== ã‚¨ãƒ‡ã‚£ã‚¿ ===== -->
<section class="panel panel--editor" id="editor">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Writing Toolkit</span>
      <h2 class="panel-title">æœ¬æ–‡ã‚¨ãƒ‡ã‚£ã‚¿</h2>
      <p class="panel-description">ã“ã“ã§ç·¨é›†ã—ã¾ã—ã‚‡ã†ã€‚å…¥åŠ›å†…å®¹ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã«è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ã€‚</p>
    </div>
  </header>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ä¿å­˜ å…¼ç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿å­˜ã¯ formaction ã§åˆ‡æ›¿ï¼‰ -->
  <form method="post" action="{{ url_for('preview') }}" novalidate>
    <label for="text">ã‚¿ã‚°ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</label>

    <div class="shortcut-bar">
      <button type="button" class="ins" data-insert="[newpage]">[newpage]</button>
      <button type="button" class="ins" data-insert="[chapter:ç« ã‚¿ã‚¤ãƒˆãƒ«]">[chapter]</button>
      <button type="button" class="ins" data-insert="[uploadedimage:123456]">[uploadedimage]</button>
      <button type="button" class="ins" data-insert="[jump:2]">[jump]</button>
      <button type="button" class="ins" data-insert="[[jumpuri:ã‚¿ã‚¤ãƒˆãƒ« > https://example.com]]">[[jumpuri]]</button>
      <button type="button" class="ins" data-insert="[[rb:æ¼¢å­— > ã‹ã‚“ã˜]]">[[rb]]</button>
    </div>

    <textarea id="text" name="text" rows="18" placeholder="ã“ã“ã«æœ¬æ–‡">{{ default_text }}</textarea>

    <div class="toolbar">
      <label>è¡¨ç¤ºæ–¹å‘:
        <select name="writing_mode">
          <option value="horizontal" {% if writing_mode == 'horizontal' %}selected{% endif %}>æ¨ªæ›¸ã</option>
          <option value="vertical" {% if writing_mode == 'vertical' %}selected{% endif %}>ç¸¦æ›¸ã</option>
        </select>
      </label>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <button type="submit" data-ajax-preview>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>

      <!-- ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ› -->
      <input
        type="text"
        name="filename"
        placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: story.txtï¼‰"
        value="{{ last_filename or '' }}"
      >

      <!-- ğŸ”¹ ä¸€è¦§è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆå…ˆã«æ¥ã‚‹ï¼‰ -->
      <a href="{{ url_for('saves_list') }}" class="btn">ä¿å­˜ã—ãŸä½œå“ã‚’ä¸€è¦§è¡¨ç¤º</a>

      <!-- ğŸ”¹ ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå¾Œã«æ¥ã‚‹ï¼‰ -->
      <button
        type="button"
        class="primary"
        data-ajax-save
        data-action="{{ url_for('save_local') }}"
      >ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜</button>

      <button
        type="submit"
        formaction="{{ url_for('export') }}"
        formmethod="post"
      >TXTã¨ã—ã¦ä¿å­˜</button>
    </div>

  </form>

  {% if cloud_targets %}
<section class="panel panel--cloud" id="cloud-mirror">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Cloud Mirror</span>
      <h2 class="panel-title">ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
      <p class="panel-description">Google Cloud Storage ä¸Šã®ãƒŸãƒ©ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€ã¸ç´ æ—©ãã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¢ºèªã‚„å…±æœ‰æ¨©é™ã®èª¿æ•´ã«æ´»ç”¨ã—ã¦ãã ã•ã„ã€‚</p>
    </div>
  </header>

  <div class="cloud-links">
    {% for provider in cloud_targets %}
      {% if provider.uploads_url %}
        <article class="cloud-link-card" data-provider="{{ provider.key }}" data-section="uploads">
          <h3 class="cloud-link-card__title">{{ provider.label }} æŒ¿çµµã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h3>
          <p class="cloud-link-card__text"><code>uploads/</code> ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚åˆ¥ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰ç´ æã‚’å–ã‚Šè¾¼ã‚€éš›ã‚„å±¥æ­´ã®ç¢ºèªã«ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
          <a class="link-button subtle" href="{{ provider.uploads_url }}" target="_blank" rel="noopener">{{ provider.label }} ã§é–‹ã</a>
        </article>
      {% endif %}

      {% if provider.saves_url %}
        <article class="cloud-link-card" data-provider="{{ provider.key }}" data-section="saves">
          <h3 class="cloud-link-card__title">{{ provider.label }} ãƒ†ã‚­ã‚¹ãƒˆä¿å­˜</h3>
          <p class="cloud-link-card__text"><code>saves/</code> ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®åŸç¨¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
          <a class="link-button subtle" href="{{ provider.saves_url }}" target="_blank" rel="noopener">{{ provider.label }} ã§é–‹ã</a>
        </article>
      {% endif %}
    {% endfor %}
  </div>

  {% if cloud_manifest.gcs.enabled %}
    <div class="cloud-note cloud-note--accent">
      <p><strong>Google Cloud Storage æ¥ç¶šæƒ…å ±</strong></p>
      <ul>
        <li>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ ID: <code>{{ cloud_manifest.gcs.project }}</code></li>
        <li>ãƒã‚±ãƒƒãƒˆå: <code>{{ cloud_manifest.gcs.bucket }}</code></li>
        <li>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: <code>{{ cloud_manifest.gcs.service_account }}</code></li>
        {% set creds = cloud_manifest.gcs.credentials %}
        {% if creds.source %}
          <li>è³‡æ ¼æƒ…å ±ã‚½ãƒ¼ã‚¹: <code>{{ creds.source }}</code>{% if creds.path %} (<code>{{ creds.path }}</code>){% endif %}</li>
        {% endif %}
        {% if creds.env_path %}
          <li>GOOGLE_APPLICATION_CREDENTIALS: <code>{{ creds.env_path }}</code>
            {% if creds.env_path_exists %}
              <span aria-label="credential path resolved" title="credential path resolved">âœ…</span>
            {% else %}
              <span aria-label="credential path missing" title="credential path missing">âš ï¸</span>
            {% endif %}
          </li>
        {% endif %}
      </ul>
      <p>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«å¯¾è±¡ãƒã‚±ãƒƒãƒˆã¸ã®æ›¸ãè¾¼ã¿æ¨©é™ãŒã‚ã‚‹ã‹ã€Render ç­‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒã«è³‡æ ¼æƒ…å ±ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹ã‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>
    </div>
  {% else %}
    <p class="cloud-note">ã‚¯ãƒ©ã‚¦ãƒ‰ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã«ã¯ã€ç’°å¢ƒå¤‰æ•°ã§ Google Cloud Storage ã®è³‡æ ¼æƒ…å ±ã¨ãƒã‚±ãƒƒãƒˆåã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>
  {% endif %}
</section>
{% endif %}

<script>
(() => {
  const textEl = document.getElementById('text');
  const nameEl = document.querySelector('input[name="filename"]');
  const form   = document.querySelector('form[action$="/preview"]'); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ•ã‚©ãƒ¼ãƒ 

  // draft ç”¨ã‚­ãƒ¼
  const draftKey = () => `pixi:draft:${(nameEl?.value || '(untitled)').trim()}`;

  // 1) ãƒ­ãƒ¼ãƒ‰æ™‚ï¼šä¸‹æ›¸ããŒã‚ã‚Œã°å„ªå…ˆçš„ã«å¾©å…ƒ
  try {
    const k = draftKey();
    const draft = localStorage.getItem(k);
    if (draft && draft !== textEl.value) {
      // è‡ªå‹•å¾©å…ƒï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«ã—ãŸã„å ´åˆã¯ confirm ã«å¤‰æ›´ï¼‰
      textEl.value = draft;
    }
  } catch(e){ /* ignore */ }

  // 2) å…¥åŠ›ã®åº¦ã«ä¸‹æ›¸ãä¿å­˜ï¼ˆè»½ã„ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  let t = null;
  const saveDraft = () => {
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  };
  const debounced = () => { clearTimeout(t); t = setTimeout(saveDraft, 250); };
  textEl.addEventListener('input', debounced);

  // 3) ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰ãˆãŸã‚‰ã€æ—¢å­˜ä¸‹æ›¸ãã¯ãã®ã¾ã¾ã«ã—ã¤ã¤æ–°ã‚­ãƒ¼ã¸ã‚‚ä¿å­˜
  nameEl?.addEventListener('change', () => {
    saveDraft(); // æ—§ã‚­ãƒ¼ã¸ã¾ãšä¿å­˜
    // æ–°ã‚­ãƒ¼ã«ã‚‚è¤‡è£½ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  });

  // 4) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é€ä¿¡å‰ã«ã‚‚å¿…ãšä¸‹æ›¸ãä¿å­˜
  form?.addEventListener('submit', () => {
    saveDraft();
  });

  // 5) ã¤ã„ã§ã«ã€Œä¿å­˜æˆåŠŸã€æ™‚ã«ä¸‹æ›¸ãã‚’â€œæ­£â€ã¨ã—ã¦å›ºå®šï¼ˆä»»æ„ï¼‰
  document.addEventListener('pixi:saved', (ev) => {
    try {
      if (ev?.detail?.filename && nameEl) {
        nameEl.value = ev.detail.filename;
      }
      saveDraft();
    } catch (e) { /* ignore */ }
  });
})();
</script>

{% endblock %}
