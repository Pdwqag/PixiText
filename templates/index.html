{% extends "base.html" %}
{% block content %}

<!-- ===== ã‚¨ãƒ‡ã‚£ã‚¿ ===== -->
<section class="panel">
  <h2>æœ¬æ–‡ã‚¨ãƒ‡ã‚£ã‚¿</h2>

  <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼/ä¿å­˜ å…¼ç”¨ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆä¿å­˜ã¯ formaction ã§åˆ‡æ›¿ï¼‰ -->
  <form method="post" action="{{ url_for('preview') }}" novalidate>
    <label for="text">ã‚¿ã‚°ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ</label>

    <div class="shortcut-bar">
      <button type="button" class="ins" data-insert="[newpage]">[newpage]</button>
      <button type="button" class="ins" data-insert="[chapter:ç« ã‚¿ã‚¤ãƒˆãƒ«]">[chapter]</button>
      <button type="button" class="ins" data-insert="[uploadedimage:12345]">[uploadedimage]</button>
      <button type="button" class="ins" data-insert="[pixivimage:123456789]">[pixivimage]</button>
      <button type="button" class="ins" data-insert="[jump:2]">[jump]</button>
      <button type="button" class="ins" data-insert="[[jumpuri:ã‚¿ã‚¤ãƒˆãƒ« > https://example.com]]">[[jumpuri]]</button>
      <button type="button" class="ins" data-insert="[[rb:æ¼¢å­— > ã‹ã‚“ã˜]]">[[rb]]</button>
    </div>

    <textarea id="text" name="text" rows="18" placeholder="ã“ã“ã«æœ¬æ–‡">{{ default_text }}</textarea>

    <div class="toolbar">
      <label>è¡¨ç¤ºæ–¹å‘:
        <select name="writing_mode">
          <option value="horizontal" {% if writing_mode == 'horizontal' %}selected{% endif %}>æ¨ªæ›¸ã</option>
          <option value="vertical" {% if writing_mode == 'vertical' %}selected{% endif %}>ç¸¦æ›¸ã</option>
        </select>
      </label>

      <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
      <button type="submit">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</button>

      <!-- ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ› -->
      <input
        type="text"
        name="filename"
        placeholder="ãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆä¾‹: story.txtï¼‰"
        value="{{ last_filename or '' }}"
      >

      <!-- ğŸ”¹ ä¸€è¦§è¡¨ç¤ºãƒœã‚¿ãƒ³ï¼ˆå…ˆã«æ¥ã‚‹ï¼‰ -->
      <a href="{{ url_for('saves_list') }}" class="btn">ä¿å­˜ã—ãŸä½œå“ã‚’ä¸€è¦§è¡¨ç¤º</a>

      <!-- ğŸ”¹ ä¿å­˜ãƒœã‚¿ãƒ³ï¼ˆå¾Œã«æ¥ã‚‹ï¼‰ -->
      <button
        type="button"
        class="primary"
        data-ajax-save
        data-action="{{ url_for('save_local') }}"
      >ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜</button>

      <button
        type="submit"
        formaction="{{ url_for('export') }}"
        formmethod="post"
      >HTMLã¨ã—ã¦ä¿å­˜</button>
    </div>

  </form>
</section>

<!-- ===== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ===== -->
<section class="panel">
  <h3>ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆæŒ¿çµµï¼‰</h3>

  <!-- base.html å´ã® â€œæœªé¸æŠãƒˆãƒ¼ã‚¹ãƒˆâ€ ã¨ style.css ã®ã‚«ã‚¹ã‚¿ãƒ UIã«å¯¾å¿œ -->
  <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data">
    <label class="file-uploader">
      <input type="file" name="file" accept="image/*">
      <span class="fu-btn">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
      <span class="fu-name" data-placeholder="ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
    </label>
    <button type="submit" class="primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
  </form>

  <!-- ===== ãƒŸãƒ‹ã‚®ãƒ£ãƒ©ãƒªãƒ¼ ===== -->
  {% if gallery_items %}
    <hr>
    <h2 style="margin:16px 0 8px;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ç”»åƒ</h2>

    <div class="mg-grid">
      {% for it in gallery_items %}
      <div class="mg-card">
        <a class="mg-thumb" href="{{ url_for('image_by_id', img_id=it.id) }}" target="_blank" rel="noopener">
          <span class="mg-badge">ID: {{ it.id }}</span>
          <img src="{{ url_for('image_by_id', img_id=it.id) }}" alt="{{ it.original_name or it.stored_name }}">
        </a>
        <div class="mg-body">
          <div class="mg-id">#{{ it.id }}</div>
          <div class="mg-name" title="{{ it.original_name or it.stored_name }}">{{ it.original_name or it.stored_name }}</div>

          <div class="mg-actions">
            <input id="tag-{{ it.id }}" class="mg-code" type="text" readonly value="[uploadedimage:{{ it.id }}]">
            <button class="mg-btn copy" type="button" data-copy="[uploadedimage:{{ it.id }}]">ã‚³ãƒ”ãƒ¼</button>

            <!-- base.html ã® confirm ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ.js-deleteï¼‰ã§æ¨ªå–ã‚Šã—ã¦ã‹ã‚‰ submit -->
            <form method="post"
                  action="{{ url_for('delete_image', img_id=it.id, next='index') }}"
                  class="js-delete" data-id="{{ it.id }}">
              <button class="mg-btn delete" type="submit">å‰Šé™¤</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <p class="mg-toplink">
      <a href="{{ url_for('gallery') }}" class="link-button">ã™ã¹ã¦ã®ç”»åƒã‚’ä¸€è¦§è¡¨ç¤º</a>
    </p>
  {% else %}
    <p style="opacity:.8;margin-top:8px;">ã¾ã ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
  {% endif %}
</section>

<!-- ï¼ˆç”»åƒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã®ï¼‰æœ€å¾Œã® </section> ã®ã™ãå¾Œã«è¿½åŠ  -->
<script>
(() => {
  // äºŒé‡ãƒã‚¤ãƒ³ãƒ‰é˜²æ­¢
  const btn = document.querySelector('[data-ajax-save]');
  if (!btn || btn.dataset.bound === '1') return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', async () => {
    const action = btn.dataset.action;                 // ä¾‹: "/save_local"
    const textEl = document.getElementById('text');    // æœ¬æ–‡ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢
    const nameEl = document.querySelector('input[name="filename"]'); // ãƒ•ã‚¡ã‚¤ãƒ«åå…¥åŠ›

    const fd = new FormData();
    fd.append('text', textEl?.value ?? '');
    fd.append('filename', (nameEl?.value || '').trim());  // â† å¿…ãšé€ã‚‹

    try {
      const r = await fetch(action, { method: 'POST', body: fd });
      const res = await r.json().catch(() => ({}));
      // å¥½ããªUIã«ç½®ãæ›ãˆã¦OKï¼ˆãƒˆãƒ¼ã‚¹ãƒˆç­‰ï¼‰
      alert(res.message || (res.success ? 'ä¿å­˜ã—ã¾ã—ãŸ' : 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ'));
    } catch (e) {
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
    }
  });
})();
</script>
<script>
(() => {
  const textEl = document.getElementById('text');
  const nameEl = document.querySelector('input[name="filename"]');
  const form   = document.querySelector('form[action$="/preview"]'); // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ãƒ•ã‚©ãƒ¼ãƒ 

  // draft ç”¨ã‚­ãƒ¼
  const draftKey = () => `pixi:draft:${(nameEl?.value || '(untitled)').trim()}`;

  // 1) ãƒ­ãƒ¼ãƒ‰æ™‚ï¼šä¸‹æ›¸ããŒã‚ã‚Œã°å„ªå…ˆçš„ã«å¾©å…ƒ
  try {
    const k = draftKey();
    const draft = localStorage.getItem(k);
    if (draft && draft !== textEl.value) {
      // è‡ªå‹•å¾©å…ƒï¼ˆç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã«ã—ãŸã„å ´åˆã¯ confirm ã«å¤‰æ›´ï¼‰
      textEl.value = draft;
    }
  } catch(e){ /* ignore */ }

  // 2) å…¥åŠ›ã®åº¦ã«ä¸‹æ›¸ãä¿å­˜ï¼ˆè»½ã„ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼‰
  let t = null;
  const saveDraft = () => {
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  };
  const debounced = () => { clearTimeout(t); t = setTimeout(saveDraft, 250); };
  textEl.addEventListener('input', debounced);

  // 3) ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å¤‰ãˆãŸã‚‰ã€æ—¢å­˜ä¸‹æ›¸ãã¯ãã®ã¾ã¾ã«ã—ã¤ã¤æ–°ã‚­ãƒ¼ã¸ã‚‚ä¿å­˜
  nameEl?.addEventListener('change', () => {
    saveDraft(); // æ—§ã‚­ãƒ¼ã¸ã¾ãšä¿å­˜
    // æ–°ã‚­ãƒ¼ã«ã‚‚è¤‡è£½ï¼ˆå¿…è¦ãªã‚‰ï¼‰
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  });

  // 4) ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é€ä¿¡å‰ã«ã‚‚å¿…ãšä¸‹æ›¸ãä¿å­˜
  form?.addEventListener('submit', () => {
    saveDraft();
  });

  // 5) ã¤ã„ã§ã«ã€Œä¿å­˜æˆåŠŸã€æ™‚ã«ä¸‹æ›¸ãã‚’â€œæ­£â€ã¨ã—ã¦å›ºå®šï¼ˆä»»æ„ï¼‰
  const origAlert = window.alert;
  window.alert = function(msg){
    try{
      if (typeof msg === 'string' && msg.includes('ä¿å­˜ã—ã¾ã—ãŸ')) {
        // ä¿å­˜å¾Œã®æœ¬æ–‡ã‚’ç¾ã‚­ãƒ¼ã«ç¢ºå®š
        localStorage.setItem(draftKey(), textEl.value);
      }
    }catch(e){}
    return origAlert.apply(this, arguments);
  };
})();
</script>

{% endblock %}
