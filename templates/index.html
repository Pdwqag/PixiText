{% extends "base.html" %}
{% block content %}

<!-- ===== ヒーロー / ガイド ===== -->
<section class="hero-card">
  <span class="hero-card__badge">Creative Workspace</span>
  <h2 class="hero-card__title">PixiText Studio</h2>
  <p class="hero-card__lead">テキストと挿絵をローカル環境でスムーズに扱うためのモダンな制作ツールです。ドラフトの保存からギャラリー管理まで、すべてがワンクリックで完結します。</p>
  <div class="hero-actions">
    <a class="link-button primary" href="#editor">エディタを開く</a>
    <a class="link-button subtle" href="{{ url_for('gallery') }}">ギャラリーを見る</a>
  </div>
</section>

<!-- ===== エディタ ===== -->
<section class="panel panel--editor" id="editor">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Writing Toolkit</span>
      <h2 class="panel-title">本文エディタ</h2>
      <p class="panel-description">タグショートカットやプレビューを活用しながら、作品原稿を磨き上げましょう。入力内容はブラウザ内に自動保存されます。</p>
    </div>
  </header>

  <!-- プレビュー/保存 兼用フォーム（保存は formaction で切替） -->
  <form method="post" action="{{ url_for('preview') }}" novalidate>
    <label for="text">タグのショートカット</label>

    <div class="shortcut-bar">
      <button type="button" class="ins" data-insert="[newpage]">[newpage]</button>
      <button type="button" class="ins" data-insert="[chapter:章タイトル]">[chapter]</button>
      <button type="button" class="ins" data-insert="[uploadedimage:123456]">[uploadedimage]</button>
      <button type="button" class="ins" data-insert="[jump:2]">[jump]</button>
      <button type="button" class="ins" data-insert="[[jumpuri:タイトル > https://example.com]]">[[jumpuri]]</button>
      <button type="button" class="ins" data-insert="[[rb:漢字 > かんじ]]">[[rb]]</button>
    </div>

    <textarea id="text" name="text" rows="18" placeholder="ここに本文">{{ default_text }}</textarea>

    <div class="toolbar">
      <label>表示方向:
        <select name="writing_mode">
          <option value="horizontal" {% if writing_mode == 'horizontal' %}selected{% endif %}>横書き</option>
          <option value="vertical" {% if writing_mode == 'vertical' %}selected{% endif %}>縦書き</option>
        </select>
      </label>

      <!-- プレビュー -->
      <button type="submit">プレビュー</button>

      <!-- ファイル名入力 -->
      <input
        type="text"
        name="filename"
        placeholder="ファイル名（例: story.txt）"
        value="{{ last_filename or '' }}"
      >

      <!-- 🔹 一覧表示ボタン（先に来る） -->
      <a href="{{ url_for('saves_list') }}" class="btn">保存した作品を一覧表示</a>

      <!-- 🔹 保存ボタン（後に来る） -->
      <button
        type="button"
        class="primary"
        data-ajax-save
        data-action="{{ url_for('save_local') }}"
      >ローカルに保存</button>

      <button
        type="submit"
        formaction="{{ url_for('export') }}"
        formmethod="post"
      >HTMLとして保存</button>
    </div>

  </form>
</section>

<!-- ===== 画像アップロード ===== -->
<section class="panel">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Illustration Assets</span>
      <h2 class="panel-title">画像アップロード（挿絵）</h2>
      <p class="panel-description">アップロード済みの画像はショートコードとして呼び出せます。必要に応じてギャラリーから整理・削除してください。</p>
    </div>
  </header>

  <!-- base.html 側の “未選択トースト” と style.css のカスタムUIに対応 -->
  <form method="post" action="{{ url_for('upload') }}" enctype="multipart/form-data">
    <label class="file-uploader">
      <input type="file" name="file" accept="image/*">
      <span class="fu-btn">ファイルを選択</span>
      <span class="fu-name" data-placeholder="ファイルが選択されていません">ファイルが選択されていません</span>
    </label>
    <button type="submit" class="primary">アップロード</button>
  </form>

  <!-- ===== ミニギャラリー ===== -->
  {% if gallery_items %}
    <div class="panel-divider"></div>
    <div class="panel-heading panel-heading--compact">
      <div class="panel-heading__text">
        <h3 class="panel-title">アップロード済み画像</h3>
        <p class="panel-description">ショートコードをコピーして本文に貼り付けると挿絵として表示されます。</p>
      </div>
    </div>

    <div class="mg-grid">
      {% for it in gallery_items %}
      <div class="mg-card">
        <a class="mg-thumb" href="{{ url_for('image_by_id', img_id=it.id) }}" target="_blank" rel="noopener">
          <img src="{{ url_for('image_by_id', img_id=it.id) }}" alt="{{ it.original_name or it.stored_name }}">
        </a>
        <div class="mg-body">
          <div class="mg-name" title="{{ it.original_name or it.stored_name }}">{{ it.original_name or it.stored_name }}</div>

          <div class="mg-actions">
            <input id="tag-{{ it.id }}" class="mg-code" type="text" readonly value="[uploadedimage:{{ it.id }}]">
            <button class="mg-btn copy" type="button" data-copy="[uploadedimage:{{ it.id }}]">コピー</button>

            <!-- base.html の confirm モーダル（.js-delete）で横取りしてから submit -->
            <form method="post"
                  action="{{ url_for('delete_image', img_id=it.id, next='index') }}"
                  class="js-delete" data-id="{{ it.id }}">
              <button class="mg-btn delete" type="submit">削除</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <p class="mg-toplink">
      <a href="{{ url_for('gallery') }}" class="link-button">すべての画像を一覧表示</a>
    </p>
  {% else %}
    <p class="empty-hint">まだ画像がありません。上のフォームからアップロードしてください。</p>
  {% endif %}

  {% if cloud_targets|selectattr('key', 'equalto', 'sync')|list %}
    <div class="cloud-note cloud-note--accent">
      <p>Sync.com を利用する場合は次の流れで設定してください。</p>
      <ol>
        <li><a href="https://cp.sync.com/files" target="_blank" rel="noopener">cp.sync.com/files</a> にサインインし、<code>uploads</code> と <code>saves</code> の2フォルダを用意します。</li>
        <li>このアプリから <a href="{{ url_for('sync_manifest_export') }}">マニフェスト JSON</a> をダウンロードし、バックアップ用フォルダにアップロードします。</li>
        <li>Sync.com 側で JSON ファイルを共有し、その公開リンクを環境変数 <code>SYNC_MANIFEST_URL</code>（または設定ファイル）に登録します。</li>
      </ol>
      <p>設定後は上の一覧で Sync.com の最新情報を再読み込みできます。</p>
    </div>
  {% endif %}

  <p class="cloud-note">リンク先は共有フォルダです。サービス側の管理画面からアクセス権や同期設定を調整してください。</p>
</section>
{% endif %}

{% if mega_uploads_url or mega_saves_url %}
<section class="panel panel--cloud" id="cloud-mirror">
  <header class="panel-heading">
    <div class="panel-heading__text">
      <span class="panel-kicker">Cloud Mirror</span>
      <h2 class="panel-title">MEGA バックアップ</h2>
      <p class="panel-description">ローカル保存に加えて、共有済みの MEGA フォルダからファイルを取得・同期できます。必要なときに素早くアクセスできるよう、ショートカットをまとめました。</p>
    </div>
  </header>

  <div class="cloud-links">
    {% if mega_uploads_url %}
      <article class="cloud-link-card">
        <h3 class="cloud-link-card__title">挿絵アップロード</h3>
        <p class="cloud-link-card__text"><code>uploads/</code> 内の画像ファイルをミラーしています。別デバイスから素材を取り込みたいときにご利用ください。</p>
        <a class="link-button subtle" href="{{ mega_uploads_url }}" target="_blank" rel="noopener">MEGA で開く</a>
      </article>
    {% endif %}

    {% if mega_saves_url %}
      <article class="cloud-link-card">
        <h3 class="cloud-link-card__title">テキスト保存</h3>
        <p class="cloud-link-card__text"><code>saves/</code> にあるテキスト原稿のバックアップです。万一ローカルが失われた場合でも、ここからダウンロードして復旧できます。</p>
        <a class="link-button subtle" href="{{ mega_saves_url }}" target="_blank" rel="noopener">MEGA で開く</a>
      </article>
    {% endif %}
  </div>

  <p class="cloud-note">リンク先は共有フォルダです。必要に応じてご自身の MEGA アカウントへコピーし、アクセス権管理を行ってください。</p>
</section>
{% endif %}

<script>
(() => {
  const textEl = document.getElementById('text');
  const nameEl = document.querySelector('input[name="filename"]');
  const form   = document.querySelector('form[action$="/preview"]'); // プレビュー用フォーム

  // draft 用キー
  const draftKey = () => `pixi:draft:${(nameEl?.value || '(untitled)').trim()}`;

  // 1) ロード時：下書きがあれば優先的に復元
  try {
    const k = draftKey();
    const draft = localStorage.getItem(k);
    if (draft && draft !== textEl.value) {
      // 自動復元（確認ダイアログにしたい場合は confirm に変更）
      textEl.value = draft;
    }
  } catch(e){ /* ignore */ }

  // 2) 入力の度に下書き保存（軽いデバウンス）
  let t = null;
  const saveDraft = () => {
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  };
  const debounced = () => { clearTimeout(t); t = setTimeout(saveDraft, 250); };
  textEl.addEventListener('input', debounced);

  // 3) ファイル名を変えたら、既存下書きはそのままにしつつ新キーへも保存
  nameEl?.addEventListener('change', () => {
    saveDraft(); // 旧キーへまず保存
    // 新キーにも複製（必要なら）
    try { localStorage.setItem(draftKey(), textEl.value); } catch(e){}
  });

  // 4) プレビュー送信前にも必ず下書き保存
  form?.addEventListener('submit', () => {
    saveDraft();
  });

  // 5) ついでに「保存成功」時に下書きを“正”として固定（任意）
  document.addEventListener('pixi:saved', (ev) => {
    try {
      if (ev?.detail?.filename && nameEl) {
        nameEl.value = ev.detail.filename;
      }
      saveDraft();
    } catch (e) { /* ignore */ }
  });
})();
</script>

{% endblock %}
